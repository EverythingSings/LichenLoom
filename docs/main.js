document.addEventListener('DOMContentLoaded',()=>{const tree=document.getElementById('story-tree');const nav=document.getElementById('nav');const canvas=document.getElementById('mycelial');if(!tree||!nav||!canvas)return;const ctx=canvas.getContext('2d');const nodes=[];function traverse(ul,parent=null){for(const li of ul.children){const link=li.querySelector('a');const node={label:link?link.textContent:li.firstChild.textContent.trim(),href:link?link.getAttribute('href'):null,parent,x:canvas.width/2+(Math.random()-0.5)*20,y:canvas.height/2+(Math.random()-0.5)*20,vx:0,vy:0};nodes.push(node);const sub=li.querySelector(':scope>ul');if(sub)traverse(sub,node);}}traverse(tree);const anchors=nodes.map(n=>{const a=document.createElement('a');a.className='node';if(n.href)a.href=n.href;a.dataset.label=n.label;nav.appendChild(a);return a;});const links=nodes.filter(n=>n.parent).map(n=>({source:n.parent,target:n}));let offset={x:0,y:0};let scale=1;let dragging=false;let last={x:0,y:0};canvas.addEventListener('mousedown',e=>{dragging=true;last={x:e.clientX,y:e.clientY};canvas.classList.add('dragging');});window.addEventListener('mouseup',()=>{dragging=false;canvas.classList.remove('dragging');});window.addEventListener('mousemove',e=>{if(dragging){offset.x+=e.clientX-last.x;offset.y+=e.clientY-last.y;last={x:e.clientX,y:e.clientY};}});canvas.addEventListener('wheel',e=>{e.preventDefault();scale*=e.deltaY<0?1.1:0.9;});const k=0.01,rep=2000,damp=0.6;function tick(){for(const n of nodes){if(n.parent){let dx=n.x-n.parent.x;let dy=n.y-n.parent.y;let dist=Math.hypot(dx,dy)||1;let force=(dist-80)*k;let fx=force*dx/dist;let fy=force*dy/dist;n.vx-=fx;n.vy-=fy;n.parent.vx+=fx;n.parent.vy+=fy;}}for(let i=0;i<nodes.length;i++){for(let j=i+1;j<nodes.length;j++){const a=nodes[i],b=nodes[j];let dx=a.x-b.x,dy=a.y-b.y;let dist=Math.hypot(dx,dy)||1;let force=rep/(dist*dist);let fx=force*dx/dist;let fy=force*dy/dist;a.vx+=fx;a.vy+=fy;b.vx-=fx;b.vy-=fy;}}for(const n of nodes){n.vx*=damp;n.vy*=damp;n.x+=n.vx;n.y+=n.vy;}}function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.save();ctx.translate(offset.x,offset.y);ctx.scale(scale,scale);ctx.strokeStyle='#ccc';for(const l of links){ctx.beginPath();ctx.moveTo(l.source.x,l.source.y);ctx.lineTo(l.target.x,l.target.y);ctx.stroke();}ctx.restore();for(let i=0;i<nodes.length;i++){const n=nodes[i];const a=anchors[i];a.style.left=(n.x*scale+offset.x-4)+'px';a.style.top=(n.y*scale+offset.y-4)+'px';}}function animate(){tick();draw();requestAnimationFrame(animate);}animate();});
